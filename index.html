<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pilots Jump</title>

  <!-- === CSS СТИЛИ === -->
  <style>
    /* 1) Сброс отступов */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Gloria Hallelujah', cursive;
      background: #f5f0e8;
    }

    /* 2) Контейнер всей игры */
    #gameContainer {
      position: relative;
      margin: 0 auto;
      background: url(https://i.imgur.com/Y0BMP.png) top left;
      overflow: hidden;
    }

    /* 3) Canvas: занимает 100% контейнера */
    #canvas {
      display: block;
      background: transparent;
    }

    /* 4) Скрываем тэг <img> со спрайтом */
    #sprite {
      display: none;
    }

    /* === Элементы интерфейса === */
    /* Главное меню «Play» */
    #mainMenu {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #mainMenu h1 {
      font-size: 48px;
      color: #5a5816;
      transform: rotate(-10deg);
      margin-bottom: 10px;
    }
    #mainMenu h3 {
      font-size: 20px;
      color: #5e96be;
      margin-bottom: 30px;
    }
    #btnPlay {
      width: 120px;
      height: 40px;
      background: url(https://i.imgur.com/2WEhF.png) 0 0 no-repeat;
      text-align: center;
      line-height: 40px;
      font-size: 16px;
      color: #000;
      cursor: pointer;
    }

    /* Меню «Game Over» */
    #gameOverMenu {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #gameOverMenu h1 {
      font-size: 48px;
      color: #a33;
      transform: rotate(-5deg);
      margin-bottom: 10px;
    }
    #gameOverMenu h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 30px;
    }
    #btnRestart {
      width: 120px;
      height: 40px;
      background: url(https://i.imgur.com/2WEhF.png) 0 -60px no-repeat;
      text-align: center;
      line-height: 40px;
      font-size: 16px;
      color: #000;
      cursor: pointer;
    }

    /* Счётчик очков */
    #scoreBoard {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(182,200,220,0.7);
      padding: 5px 10px;
      border-radius: 5px;
      display: none;
      z-index: 5;
    }
    #scoreBoard p {
      font-size: 18px;
      color: #000;
    }

    /* Инструкция снизу */
    #infoText {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: green;
      font-size: 14px;
      z-index: 5;
    }

    /* Невидимые зоны касания (левая/правая половины) */
    #leftZone, #rightZone {
      position: absolute;
      top: 0;
      width: 50%;
      height: 100%;
      z-index: 2;
    }
    #leftZone { left: 0; }
    #rightZone { right: 0; }

    /* Для временной отладки можно раскомментировать:
    #leftZone { background: rgba(255, 0, 0, 0.1); }
    #rightZone { background: rgba(0, 0, 255, 0.1); }
    */
  </style>
</head>
<body>
  <!-- ===== Контейнер игры ===== -->
  <div id="gameContainer">
    <!-- Canvas для рисования -->
    <canvas id="canvas"></canvas>

    <!-- Скрытый тэг <img> со спрайтом персонажа/платформ -->
    <img id="sprite" src="https://i.imgur.com/2WEhF.png" alt="spritesheet" />

    <!-- === Главное меню «Play» === -->
    <div id="mainMenu">
      <h1>Pilots Jump</h1>
      <h3>Hey Pilot, ...by Second Pilots 3D</h3>
      <div id="btnPlay">Play</div>
    </div>

    <!-- === Меню «Game Over» === -->
    <div id="gameOverMenu">
      <h1>Game Over!</h1>
      <h3 id="go_score">You scored 0 points</h3>
      <div id="btnRestart">Restart</div>
    </div>

    <!-- Счётчик очков -->
    <div id="scoreBoard">
      <p id="score">0</p>
    </div>

    <!-- Инструкция снизу -->
    <div id="infoText">use ← → to move and space to (re)start…</div>

    <!-- Невидимые зоны касания для управления -->
    <div id="leftZone"></div>
    <div id="rightZone"></div>
  </div>

  <!-- === СТАРЫЙ <script> нужно удалить полностью! === -->

  <!-- ==================== НОВЫЙ JS-КОД (обёрнут в <script>) ==================== -->
  <script>
    // 1) Работа с Canvas и контейнером
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let width, height;

    function setCanvasSizeAndContainer() {
      const container = document.getElementById("gameContainer");

      if (typeof Telegram !== "undefined" && Telegram.WebApp) {
        // Внутри WebApp: контейнер = 100vw × (100vh – navbarHeight)
        const navbarHeight =
          parseInt(
            getComputedStyle(document.documentElement).getPropertyValue(
              "--tg-nav-bar-height"
            )
          ) || 0;

        container.style.width = "100vw";
        container.style.height = `calc(100vh - ${navbarHeight}px)`;
        container.style.marginTop = `${navbarHeight}px`;

        width = container.clientWidth;
        height = container.clientHeight;
      } else {
        // Локально: контейнер = 100vw × 100vh
        container.style.width = "100vw";
        container.style.height = "100vh";
        container.style.marginTop = "0";

        width = container.clientWidth;
        height = container.clientHeight;
      }

      canvas.width = width;
      canvas.height = height;
    }

    setCanvasSizeAndContainer();
    window.addEventListener("resize", setCanvasSizeAndContainer);

    if (typeof Telegram !== "undefined" && Telegram.WebApp) {
      Telegram.WebApp.ready();
    }

    // 2) Игровые переменные и инициализация
    let platforms = [];
    const image = document.getElementById("sprite");
    let player, base, Spring, platform_broken_substitute;

    const platformCount = 10;
    let position = 0,
      gravity = 0.2,
      animloop,
      flag = 0,
      broken = 0,
      dir = "left",
      score = 0,
      firstRun = true,
      jumpCount = 0;

    // ==================== КЛАССЫ ====================
    class Base {
      constructor() {
        this.height = 5;
        this.width = width;
        this.cx = 0;
        this.cy = 614;
        this.cwidth = 100;
        this.cheight = 5;
        this.x = 0;
        this.y = height - this.height;
      }
      draw() {
        try {
          ctx.drawImage(
            image,
            this.cx,
            this.cy,
            this.cwidth,
            this.cheight,
            this.x,
            this.y,
            this.width,
            this.height
          );
        } catch (e) {}
      }
    }

    class Player {
      constructor() {
        this.vy = 11;
        this.vx = 0;
        this.isMovingLeft = false;
        this.isMovingRight = false;
        this.isDead = false;
        this.width = 55;
        this.height = 40;
        this.cx = 0;
        this.cy = 0;
        this.cwidth = 110;
        this.cheight = 80;
        this.dir = "left";
        this.x = width / 2 - this.width / 2;
        this.y = height;
      }
      draw() {
        try {
          if (this.dir === "right") this.cy = 121;
          else if (this.dir === "left") this.cy = 201;
          else if (this.dir === "right_land") this.cy = 289;
          else if (this.dir === "left_land") this.cy = 371;

          ctx.drawImage(
            image,
            this.cx,
            this.cy,
            this.cwidth,
            this.cheight,
            this.x,
            this.y,
            this.width,
            this.height
          );
        } catch (e) {}
      }
      jump() {
        // Базовая сила прыжка + небольшое увеличение от счёта
        const baseJump = 6;
        const extra = Math.min(score * 0.0005, 4); // максимум +4
        this.vy = -(baseJump + extra);
      }
      jumpHigh() {
        const baseHigh = 12;
        const extraHigh = Math.min(score * 0.0007, 6); // максимум +6
        this.vy = -(baseHigh + extraHigh);
      }
    }

    class Platform {
      constructor() {
        this.width = 70;
        this.height = 17;
        this.x = Math.random() * (width - this.width);
        this.y = position;
        position += height / platformCount;
        this.flag = 0;
        this.state = 0;
        this.cx = 0;
        this.cy = 0;
        this.cwidth = 105;
        this.cheight = 31;

        if (score >= 5000) this.types = [2, 3, 3, 3, 4, 4, 4, 4];
        else if (score >= 2000 && score < 5000)
          this.types = [2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4];
        else if (score >= 1000 && score < 2000)
          this.types = [2, 2, 2, 3, 3, 3, 3, 3];
        else if (score >= 500 && score < 1000)
          this.types = [1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3];
        else if (score >= 100 && score < 500) this.types = [1, 1, 1, 1, 2, 2];
        else this.types = [1];

        this.type = this.types[Math.floor(Math.random() * this.types.length)];

        if (this.type === 3 && broken < 1) {
          broken++;
        } else if (this.type === 3 && broken >= 1) {
          this.type = 1;
          broken = 0;
        }
        this.vx = 1;
      }
      draw() {
        try {
          if (this.type === 1) this.cy = 0;
          else if (this.type === 2) this.cy = 61;
          else if (this.type === 3 && this.flag === 0) this.cy = 31;
          else if (this.type === 3 && this.flag === 1) this.cy = 1000;
          else if (this.type === 4 && this.state === 0) this.cy = 90;
          else if (this.type === 4 && this.state === 1) this.cy = 1000;

          ctx.drawImage(
            image,
            this.cx,
            this.cy,
            this.cwidth,
            this.cheight,
            this.x,
            this.y,
            this.width,
            this.height
          );
        } catch (e) {}
      }
    }

    class PlatformBrokenSub {
      constructor() {
        this.height = 30;
        this.width = 70;
        this.x = 0;
        this.y = 0;
        this.cx = 0;
        this.cy = 554;
        this.cwidth = 105;
        this.cheight = 60;
        this.appearance = false;
      }
      draw() {
        try {
          if (this.appearance) {
            ctx.drawImage(
              image,
              this.cx,
              this.cy,
              this.cwidth,
              this.cheight,
              this.x,
              this.y,
              this.width,
              this.height
            );
          }
        } catch (e) {}
      }
    }

    class SpringClass {
      constructor() {
        this.x = 0;
        this.y = 0;
        this.width = 26;
        this.height = 30;
        this.cx = 0;
        this.cy = 0;
        this.cwidth = 45;
        this.cheight = 53;
        this.state = 0;
      }
      draw() {
        try {
          if (this.state === 0) this.cy = 445;
          else if (this.state === 1) this.cy = 501;
          ctx.drawImage(
            image,
            this.cx,
            this.cy,
            this.cwidth,
            this.cheight,
            this.x,
            this.y,
            this.width,
            this.height
          );
        } catch (e) {}
      }
    }

    // Инициализация объектов до старта
    base = new Base();
    player = new Player();
    Spring = new SpringClass();
    platform_broken_substitute = new PlatformBrokenSub();
    platforms = [];
    for (let i = 0; i < platformCount; i++) {
      platforms.push(new Platform());
    }

    // ==================== ФУНКЦИИ ОБНОВЛЕНИЯ ====================
    function paintCanvas() {
      ctx.clearRect(0, 0, width, height);
    }

    function playerCalc() {
      if (dir === "left") {
        player.dir = "left";
        if (player.vy < -7 && player.vy > -15) player.dir = "left_land";
      } else if (dir === "right") {
        player.dir = "right";
        if (player.vy < -7 && player.vy > -15) player.dir = "right_land";
      }

      // Горизонтальная физика («мягче»)
      if (player.isMovingLeft) {
        player.x += player.vx;
        player.vx -= 0.08;
      } else {
        player.x += player.vx;
        if (player.vx < 0) player.vx += 0.05;
      }
      if (player.isMovingRight) {
        player.x += player.vx;
        player.vx += 0.08;
      } else {
        player.x += player.vx;
        if (player.vx > 0) player.vx -= 0.05;
      }
      if (player.vx > 8) player.vx = 8;
      else if (player.vx < -8) player.vx = -8;

      // Прыжок от базы
      if ((player.y + player.height) > base.y && base.y < height) {
        player.jump();
      }

      // Game Over
      if (base.y > height && (player.y + player.height) > height && player.isDead !== "lol") {
        player.isDead = true;
      }

      // Сквозь стены
      if (player.x > width) player.x = -player.width;
      else if (player.x < -player.width) player.x = width;

      // Вертикальная физика + скролл
      if (player.y >= (height / 2) - (player.height / 2)) {
        player.y +=	player.vy;
        player.vy += gravity;
      } else {
        platforms.forEach((p, i) => {
          if (player.vy < 0) p.y -= player.vy;
          if (p.y > height) {
            platforms[i] = new Platform();
            platforms[i].y = p.y - height;
          }
        });
        base.y -= player.vy;
        player.vy += gravity;
        if (player.vy >= 0) {
         	player.y += player.vy;
          player.vy += gravity;
        }
        score++;
      }

      collides();
      if (player.isDead) gameOver();
    }

    function springCalc() {
      let s = Spring;
      let p = platforms[0];
      if (p.type === 1 || p.type === 2) {
        s.x = p.x + p.width / 2 - s.width / 2;
        s.y = p.y - p.height - 10;
        if (s.y > height / 1.1) s.state = 0;
        s.draw();
      } else {
        s.x = -s.width;
        s.y = -s.height;
      }
    }

    function platformCalc() {
      let subs = platform_broken_substitute;
      platforms.forEach((p, i) => {
        if (p.type === 2) {
          if (p.x < 0 || p.x + p.width > width) p.vx *= -1;
          p.x += p.vx;
        }
        if (p.flag === 1 && !subs.appearance && jumpCount === 0) {
          subs.x = p.x;
          subs.y = p.y;
          subs.appearance = true;
          jumpCount++;
        }
        p.draw();
      });
      if (subs.appearance) {
        subs.draw();
        subs.y += 8;
      }
      if (subs.y > height) subs.appearance = false;
    }

    function collides() {
      platforms.forEach((p, i) => {
        if (
          player.vy > 0 &&
          p.state === 0 &&
          player.x + 15 < p.x + p.width &&
          player.x + player.width - 15 > p.x &&
          player.y + player.height > p.y &&
          player.y + player.height < p.y + p.height
        ) {
          if (p.type === 3 && p.flag === 0) {
            p.flag = 1;
            jumpCount = 0;
            return;
          } else if (p.type === 4 && p.state === 0) {
           	player.jump();
            p.state = 1;
          } else if (p.flag === 1) {
            return;
          } else {
            player.jump();
          }
        }
      });

      let s = Spring;
      if (
        player.vy > 0 &&
        s.state === 0 &&
        player.x + 15 < s.x + s.width &&
        player.x + player.width - 15 > s.x &&
        player.y + player.height > s.y &&
        player.y + player.height < s.y + s.height
      ) {
        s.state = 1;
        player.jumpHigh();
      }
    }

    function updateScore() {
      document.getElementById("score").innerText = score;
    }

    function gameOver() {
      platforms.forEach((p) => {
        p.y -= 12;
      });
      if (player.y > height / 2 && flag === 0) {
        player.y -= 8;
        player.vy = 0;
      } else if (player.y < height / 2) {
        flag = 1;
      } else if (player.y + player.height > height) {
        showGameOverMenu();
        hideScore();
        player.isDead = "lol";
      }
    }

    function update() {
      paintCanvas();
      platformCalc();
      springCalc();
      playerCalc();
      player.draw();
      base.draw();
      updateScore();
    }

    // ========== ИНИЦИАЛИЗАЦИЯ ИГРЫ ==========

    function init() {
      jumpCount = 0;
      position = 0;
      score = 0;
      flag = 0;

      base = new Base();
      player = new Player();
      Spring = new SpringClass();
      platform_broken_substitute = new PlatformBrokenSub();
      platforms = [];
      for (let i = 0; i < platformCount; i++) {
        platforms.push(new Platform());
      }

      paintCanvas();
      animloop = function () {
        update();
        requestAnimationFrame(animloop);
      };
      animloop();
      hideMainMenu();
      showScore();
    }

    function reset() {
     	hideGameOverMenu();
     	showScore();
     	player.isDead = false;
     	flag = 0;
     	position = 0;
     	score = 0;
     	jumpCount = 0;

     	base = new Base();
     	player = new Player();
     	Spring = new SpringClass();
     	platform_broken_substitute = new PlatformBrokenSub();
     	platforms = [];
     	for (let i = 0; i < platformCount; i++) {
       	platforms.push(new Platform());
     	}
    }

    function hideMainMenu() {
     	document.getElementById("mainMenu").style.display = "none";
    }
    function showGameOverMenu() {
     	document.getElementById("gameOverMenu").style.display = "flex";
    }
    function hideGameOverMenu() {
     	document.getElementById("gameOverMenu").style.display = "none";
    }
    function showScore() {
     	document.getElementById("scoreBoard").style.display = "flex";
    }
    function hideScore() {
     	document.getElementById("scoreBoard").style.display = "none";
    }

    // «Демо-цикл» до старта
    function menuLoop() {
     	update();
     	requestAnimationFrame(menuLoop);
    }
    menuLoop();

    // ========== ОБРАБОТЧИКИ КНОПОК ==========
    document.getElementById("btnPlay").addEventListener("click", init);
    document.getElementById("btnRestart").addEventListener("click", reset);

    // ========== НЕВИДИМЫЕ ЗОНЫ УПРАВЛЕНИЯ ==========
    const leftZone = document.getElementById("leftZone");
   	const rightZone = document.getElementById("rightZone");

   	leftZone.addEventListener("mousedown", () => {
     	dir = "left";
     	player.isMovingLeft = true;
   	});
   	leftZone.addEventListener("mouseup", () => {
     	player.isMovingLeft = false;
   	});
   	leftZone.addEventListener("mouseleave", () => {
     	player.isMovingLeft = false;
   	});
   	leftZone.addEventListener("touchstart", (e) => {
     	e.preventDefault();
     	dir = "left";
     	player.isMovingLeft = true;
   	});
   	leftZone.addEventListener("touchend", (e) => {
     	e.preventDefault();
     	player.isMovingLeft = false;
   	});  

   	rightZone.addEventListener("mousedown", () => {
     	dir = "right";
     	player.isMovingRight = true;
   	});
   	rightZone.addEventListener("mouseup", () => {
     	player.isMovingRight = false;
   	});
   	rightZone.addEventListener("mouseleave", () => {
     	player.isMovingRight = false;
   	});
   	rightZone.addEventListener("touchstart", (e) => {
     	e.preventDefault();
     	dir = "right";
     	player.isMovingRight = true;
   	});
   	rightZone.addEventListener("touchend", (e) => {
     	e.preventDefault();
     	player.isMovingRight = false;
   	});
  </script>
  <!-- ==================== КОНЕЦ JS-КОДА ==================== -->
</body>
</html>
